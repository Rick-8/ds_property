{% extends "base.html" %}
{% block title %}All Jobs{% endblock %}
{% load static %}

{% block content %}
<h2 class="large-gold-text dark-opaque mb-4">All Jobs</h2>

<div class="d-flex justify-content-between mb-3">
  <a href="{% url 'dashboard' %}" class="btn btn-outline-silver">Back to Dashboard</a>

  <!-- Styled Delete All Jobs Button -->
  <button class="btn btn btn-red-in" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-all="true">
   <strong>Delete All Jobs</strong>
  </button>
</div>

{% if jobs %}
<table class="table table-striped align-middle">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Status</th>
      <th>Date</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for job in jobs %}
    <tr>
      <td>J{{ job.id }}</td>
      <td>{{ job.title }}</td>
      <td>{{ job.status }}</td>
      <td>{{ job.scheduled_date }}</td>
      <td>
        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-job-id="{{ job.id }}">
          Delete
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>No jobs found.</p>
{% endif %}

<!-- Reusable Modal for Job Deletion -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" id="deleteForm">
      {% csrf_token %}
      <div class="modal-content modal-background">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="deleteMessage">Are you sure you want to delete this job?</p>
          <div class="mb-3">
            <label for="password" class="form-label">Enter your password:</label>
            <input type="password" class="form-control" name="password" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-red-in">Confirm</button>
          <button type="button" class="btn btn-outline-silver" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const deleteModal = document.getElementById('confirmDeleteModal');
  const deleteMessage = document.getElementById('deleteMessage');
  deleteModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const jobId = button.getAttribute('data-job-id');
    const deleteAll = button.getAttribute('data-delete-all');
    const form = document.getElementById('deleteForm');

    if (deleteAll) {
      form.action = "{% url 'delete_all_jobs' %}";
      deleteMessage.textContent = "Are you sure you want to delete ALL jobs? This action is irreversible.";
    } else {
      form.action = `{% url 'delete_job' 0 %}`.replace('0', jobId);
      deleteMessage.textContent = "Are you sure you want to delete this job?";
    }
  });
</script>
{% endblock %}
